name: AWS Dev Deploy (Yahoo MCP)

on:
  push:
    branches:
      - aws-dev
  workflow_dispatch:

permissions:
  contents: read

env:
  DOCKER_REPOSITORY: startfinance-v2-dev-yahoo-finance-mcp

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    environment: aws-dev
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set image tag
        id: meta
        run: echo "image_tag=aws-dev-${GITHUB_SHA::12}" >> "$GITHUB_OUTPUT"

      - name: Build and push image
        env:
          DOCKERHUB_NAMESPACE: ${{ secrets.DOCKERHUB_USERNAME }}
          IMAGE_TAG: ${{ steps.meta.outputs.image_tag }}
        run: |
          docker build -t "$DOCKERHUB_NAMESPACE/$DOCKER_REPOSITORY:$IMAGE_TAG" .
          docker tag "$DOCKERHUB_NAMESPACE/$DOCKER_REPOSITORY:$IMAGE_TAG" "$DOCKERHUB_NAMESPACE/$DOCKER_REPOSITORY:aws-dev"
          docker push "$DOCKERHUB_NAMESPACE/$DOCKER_REPOSITORY:$IMAGE_TAG"
          docker push "$DOCKERHUB_NAMESPACE/$DOCKER_REPOSITORY:aws-dev"

  deploy:
    runs-on: ubuntu-latest
    environment: aws-dev
    needs: build_and_push

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          test -n "${{ secrets.EC2_HOST }}" || (echo "Missing secret: EC2_HOST" && exit 1)
          test -n "${{ secrets.EC2_USER }}" || (echo "Missing secret: EC2_USER" && exit 1)
          test -n "${{ secrets.EC2_SSH_PRIVATE_KEY }}${{ secrets.EC2_SSH_KEY }}" || (echo "Missing secret: EC2_SSH_PRIVATE_KEY (or EC2_SSH_KEY)" && exit 1)
          test -n "${{ secrets.EC2_YAHOO_MCP_DEPLOY_PATH }}" || (echo "Missing secret: EC2_YAHOO_MCP_DEPLOY_PATH" && exit 1)
          test -n "${{ secrets.DOCKERHUB_USERNAME }}" || (echo "Missing secret: DOCKERHUB_USERNAME" && exit 1)
          test -n "${{ secrets.DOCKERHUB_TOKEN }}" || (echo "Missing secret: DOCKERHUB_TOKEN" && exit 1)

      - name: Prepare runtime env file
        run: |
          printf '%s\n' "${{ secrets.AWS_DEV_YAHOO_MCP_ENV_FILE }}" > .env.aws-dev
          echo "DOCKERHUB_NAMESPACE=${{ secrets.DOCKERHUB_USERNAME }}" >> .env.aws-dev
          echo "IMAGE_TAG=${{ needs.build_and_push.outputs.image_tag }}" >> .env.aws-dev

      - name: Setup SSH
        env:
          PRIMARY_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          FALLBACK_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          install -m 700 -d ~/.ssh
          if [ -n "$PRIMARY_KEY" ]; then
            printf '%s\n' "$PRIMARY_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          else
            printf '%s\n' "$FALLBACK_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          fi
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts
          SSH_OPTS="-i ~/.ssh/id_rsa -o IdentitiesOnly=yes -o BatchMode=yes -o ConnectTimeout=10"
          if ! ssh $SSH_OPTS "$EC2_USER@$EC2_HOST" "exit 0"; then
            if [ -n "$FALLBACK_KEY" ] && [ "$FALLBACK_KEY" != "$PRIMARY_KEY" ]; then
              printf '%s\n' "$FALLBACK_KEY" | tr -d '\r' > ~/.ssh/id_rsa
              chmod 600 ~/.ssh/id_rsa
              if ! ssh $SSH_OPTS "$EC2_USER@$EC2_HOST" "exit 0"; then
                echo "SSH auth failed for both EC2_SSH_PRIVATE_KEY and EC2_SSH_KEY"
                exit 1
              fi
            else
              echo "SSH auth failed with configured key. Check EC2_SSH_PRIVATE_KEY in yahoo-mcp repo aws-dev environment."
              exit 1
            fi
          fi

      - name: Upload compose artifacts
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          DEPLOY_ROOT: ${{ secrets.EC2_YAHOO_MCP_DEPLOY_PATH }}
        run: |
          SSH_OPTS="-i ~/.ssh/id_rsa -o IdentitiesOnly=yes"
          SERVICE_PATH="${DEPLOY_ROOT%/}/mcp-yahoo"
          ssh $SSH_OPTS "$EC2_USER@$EC2_HOST" "mkdir -p '$SERVICE_PATH'"
          scp $SSH_OPTS docker-compose.aws-dev.yml "$EC2_USER@$EC2_HOST:$SERVICE_PATH/docker-compose.aws-dev.yml"
          scp $SSH_OPTS .env.aws-dev "$EC2_USER@$EC2_HOST:$SERVICE_PATH/.env.aws-dev"

      - name: Deploy on EC2
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          DEPLOY_ROOT: ${{ secrets.EC2_YAHOO_MCP_DEPLOY_PATH }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          SSH_OPTS="-i ~/.ssh/id_rsa -o IdentitiesOnly=yes"
          SERVICE_PATH="${DEPLOY_ROOT%/}/mcp-yahoo"
          printf '%s' "$DOCKERHUB_TOKEN" | ssh $SSH_OPTS "$EC2_USER@$EC2_HOST" "docker login --username '$DOCKERHUB_USERNAME' --password-stdin"
          ssh $SSH_OPTS "$EC2_USER@$EC2_HOST" "set -euo pipefail; \
            docker network inspect starterp-shared >/dev/null 2>&1 || docker network create starterp-shared; \
            cd '$SERVICE_PATH'; \
            docker compose -f docker-compose.aws-dev.yml --env-file .env.aws-dev pull; \
            docker compose -f docker-compose.aws-dev.yml --env-file .env.aws-dev up -d --remove-orphans; \
            docker compose -f docker-compose.aws-dev.yml --env-file .env.aws-dev ps"
